---
title: "Initial Results for Thesis"
author: Kagen Lim
date: 8 March 2020
output:
  html_document: default
  word_document: default
  pdf_document: default
---
```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

# Introduction

In recent years, high-profile school shootings in the United States of America have brought the issue of school safety to the forefront of international and national attention. Mass shootings, as devastating as they are, compose merely one kind of school safety threat; there are many potential scenarios that might result in severe, long-term or even fatal consequences on school-going children and teenagers across the United States (U.S.). In a more sinister vein, the prevalence of such incidents might even be unequally distributed across the school-going population. One postulation, in line with the differential opportunities theory of crime and deviance, might be that students of lower social class experience school environments that are less safe, given the existence of delinquent subcultures in their schools (Cloward & Ohlin, 1960). 

Through two studies in this thesis, which each take different quantitative approaches on the same dataset, I investigate the validity of the differential opportunities theory in accounting for socio-economic variation, within the domain of school safety. The following research question is pursued: how might socio-economic factors explain school safety, within American schools, specifically safety concerns with regard to violent incidents? This thesis utilizes the most recent edition (i.e., 2017-2018) of the School Survey of Crime and Safety (SSOCS), a cross-sectional study of American K-12 public schools by the U.S. Department of Education, and therefore is contextualized within the United States; the samples within these surveys are selected to be representative of the population of K-12 public schools across the U.S. (U.S. Department of Education, n.d.). This thesis is a contribution to extant literature in two ways. First, it is a topical contribution toward school safety, by explaining the uneven distribution of school safety threats across social class, therefore informing education and security policymaking. This adds functional value and precision to the prevention of school safety incidents. Second, it also contains a methodological contribution of integrating conventional regression modelling approaches in the social sciences with interpretable machine learning approaches, which are of great relevance today, given the burgeoning interest within the of explainable artificial intelligence (also known as XAI).

In Study 1, I investigate socio-economic variation in school safety by performing Ordinary Least Squares (OLS) regression modelling, to derive unbiased estimates of socio-economic effects that explain school safety, net of relevant explanatory and control variables, in a theoretically-driven way. A hierarchical regression approach is taken, to isolate the how individual explanatory and control variables contribute to explained variance in the dependent variable. Linear regressions like the OLS regression, however, are plagued by problems of multicollinearity when the explanatory variables are not independent of each other (Yoo et al., 2014). Such violation of the Gauss-Markov assumptions of linear regression results in biased estimators, distorting the coefficient values that are used to estimate the relationship between each given explanatory variable and the given dependent variable. Thus, when a large number of explanatory variables are of concurrent interest, as is the case with much of social scientific research in modelling complex phenomena through multivariate methods, there might be challenges amassing patterns using linear regressions. At the same time, methodological opportunities to use interpretable machine learning models are emerging, with developments in XAI showing that there is renewed interest in the interpretability of machine learning models that have a reputation for being ‘black boxes’ (Adadi & Berrada, 2018). Social scientists are increasingly cognizant of this trend, and are beginning to deploy machine learning models as an alternative to general linear models even for problems where explanation and interpretability are valued. Some of these models, like random forest regressors, are nonlinear models that are adept at ascertaining relationships between a large number of input features, and a given output variable. These application of such nonlinear machine learning models can allow researchers to entirely avoid problems of multicollinearity between features; these are also relevant for XAI goals, such as through the calculation of permutation importance scores in random forest models, to assess the contribution of given features to some given model’s prediction accuracy (Breiman, 2001; Breiman et al., 2001). Machine learning methods are thus utilized in Study 2a, on the same set of theoretically-derived features in Study 1. This enables the calculation of the relative permutation importance of each input feature on the ability to predict school safety outcomes, leading to additional insight into socio-economic variation in school safety, the primary research question of this thesis. Then, in a more data-driven way, I include more variables from the 2017-2018 SSOCS in Study 2b, some of which have not been considered together in the wider literature, to evaluate the relative permutation importance of each feature on school safety outcomes.

## Loading in Variables

```{r Load Workspace}
load("my_work_space.RData")
```

```{r full Data}
sub = read.csv('preprocessedstudy1.csv')

colnames(sub)

library(tibble)
glimpse(sub)
```

# Study 1 Intitial Results

Statistical Computing is done in R for this section. In this section, I build linear regressions hierarchically to consider variables that I found were important to consider for modelling school safety. 

In my base model, I consider two socioeconomic variables that approximate the percentage of students with low grades and those who do not consider academic performance to be important in schools; these are two features that provide a good indicator of dentifying students who are disadvantaged. 

I also consider a few control variables for the `school size` (i.e., ordinal variable with four levels, indicating how many students there are in the school, with larger values indicating a larger school), an indicator variable for whether the school is `urban` or not, and two ordinal variables with three levels (*low, medium, high*), `crime_live_recode` and `crime_area_recode`, which approximate the level of crime around where students live, and the level of crime in the vicinity around the school. These control variables were demographic variables that were previously considered by schools too. 

The following variables are indicator variables (coded as 1 or 0 for presence or absence) for whether given physical security features were implemented at a school: "visitor_badge", "control_building", "control_ground", "require_check", random_check", "lock_inside", "close_lunch", "random_sweep", "drug_testing", "wear_uniform", "dress_code", "school_lockers", "book_bags", "panic_button", emergency_notif", "anonymous_report", "student_id", "staff_id", "security_camera", "radio", prohibit_phone". For Study 1, I consider only `random_sweep`, `require_check`, `random_check`, `prohibit_phone`, `security_camera` as these were based in the literature, but for the machine learning modelling segment of the thesis I consider more of these variables.

The following are ordinal or indicator variables (coded as 1 or 0 for presence or absence) that capture parental and community involvement: "open_house", "parent_teacher_conf", "disciplinary_process", "parent_training_assist", "parenthelp_drug", "socialshelp_drug", "juvhelp_drug", "lawhelp_drug", "mhhelp_drug", "civichelp_drug", privatehelp_drug", "relighelp_drug". `open_house` and `parent_teacher_conf` are the only ordinal variables in this section, indicating the proportion of students who had at least one parent who participated in a open house or a parent teacher conference. In the order that they were listed, the rest were indicator variables indicator whether parents were consulted in the disciplinary process for schools (`disciplinary_process`), whether parents were provided assistance in the form of training initiatives on how to better help their children (`parent_training_assist`). The rest of the variables captured whether parents, social service agencies, juvenile protection agencies, legal organizations, mental health organizations, civic organizations, private enterprises were involved in drug prevention efforts for those specific schools. 

The following are indicator variables (coded as 1 or 0 for presence or absence) that capture the efforts or policies that schools invested in educating their students on skills that might help enhance school safety: "prevention_curriculum", "sel" (socio-emotional learning), "behav_mod" (behavioural modification training), "mentoring", "peer_mediation", "student_court", "restorative_circles", "promote_community".    

At each stage of these process, I drop variables if they are not statistically significant, unless they are key control variables that were included in the base model. 

## Base Model
```{r Base Models}
lm1 = lm(total_incidentslog1p ~ percentlowgradeslog1p + percentacadnotimptlog1p + school_size + urban + crime_area_recode + crime_live_recode + as.factor(school_type), sub)

library(lmtest)
resettest(lm1, power = 3) #no evidence that a square term would need to be included
resettest(lm1, power = 3) #no evidence that a cube term would need to be included

bptest(lm1) #violation of BPTest. Going forward, need to use corrected, robust standard errors. 

library(rms)

sub$school_type <- factor(sub$school_type)

lm1.1 = ols(total_incidentslog1p ~ percentlowgradeslog1p + percentacadnotimptlog1p + school_size + urban + crime_live_recode + crime_area_recode, data = sub, x = T, y = T)

lm1.2 = robcov(lm1.1)

print(lm1.2)
```

## Including Security Variables
```{r Including Security Variables}
lm2 = ols(total_incidentslog1p ~ percentlowgradeslog1p + percentacadnotimptlog1p + school_size + urban + crime_live_recode + crime_area_recode + school_type + random_sweep + require_check + random_check + prohibit_phone + security_camera, data = sub, x = T, y = T)

lm2.1 = robcov(lm2)

lrtest(lm2.1, lm1.2)

print(lm2.1)
```

## Including Parental Involvement Variables
```{r Including Parental Involvement Variables}
lm3 = ols(total_incidentslog1p ~ percentlowgradeslog1p + percentacadnotimptlog1p + school_size + urban + crime_live_recode + crime_area_recode +school_type+ random_sweep + prohibit_phone + security_camera + open_house + parent_teacher_conf + disciplinary_process + parent_training_assist + parenthelp_drug, data = sub, x = T, y = T)

lm3.1 = robcov(lm3)

lrtest(lm2.1, lm3.1)

print(lm3.1)
```

## Including Community Involvement Variables
```{r Including Community Involvement Variables}
lm4 = ols(total_incidentslog1p ~ percentlowgradeslog1p + percentacadnotimptlog1p + school_size + urban + crime_live_recode + crime_area_recode +  school_type + random_sweep + prohibit_phone + security_camera + open_house + parent_teacher_conf + socialshelp_drug + juvhelp_drug + lawhelp_drug + mhhelp_drug + civichelp_drug + privatehelp_drug + relighelp_drug, data = sub, x = T, y = T)

lm4.1 = robcov(lm4)

lrtest(lm4.1, lm3.1)

print(lm4.1)
```

## Including Student Education Variables
```{r Including Student Education Variables}
lm5 = ols(total_incidentslog1p ~ percentlowgradeslog1p + percentacadnotimptlog1p + school_size + urban + crime_live_recode + crime_area_recode +school_type +  random_sweep + prohibit_phone + open_house + parent_teacher_conf + mhhelp_drug + juvhelp_drug+ relighelp_drug + prevention_curriculum + sel + behav_mod + mentoring + peer_mediation + student_court + restorative_circles + promote_community, data = sub, x = T, y = T)

lm5.1 = robcov(lm5)

lrtest(lm5.1, lm4.1)

#likelihood ratio test

print(lm5.1)
```

## Feature Engineering: Interaction Terms

```{r Interaction Variables}
lm6 = ols(total_incidentslog1p ~ percentlowgradeslog1p + percentacadnotimptlog1p + school_size + urban + crime_live_recode + crime_area_recode +school_type +  random_sweep + prohibit_phone + open_house + parent_teacher_conf + juvhelp_drug+ mhhelp_drug + relighelp_drug + behav_mod + percentlowgradeslog1p*open_house + percentacadnotimptlog1p*open_house + percentlowgradeslog1p*parent_teacher_conf + percentacadnotimptlog1p*parent_teacher_conf, data = sub, x = T, y = T)

lm6.1 = robcov(lm6)

print(lm6.1)

lm7 = ols(total_incidentslog1p ~ percentlowgradeslog1p + percentacadnotimptlog1p + school_size + urban + crime_live_recode + crime_area_recode +school_type +  random_sweep + prohibit_phone + open_house + parent_teacher_conf + juvhelp_drug+ mhhelp_drug + relighelp_drug + percentlowgradeslog1p*juvhelp_drug + percentacadnotimptlog1p*juvhelp_drug + percentlowgradeslog1p*mhhelp_drug + percentacadnotimptlog1p*mhhelp_drug + percentlowgradeslog1p*relighelp_drug + percentacadnotimptlog1p*relighelp_drug, data = sub, x = T, y = T)

lm7.1 = robcov(lm7)

print(lm7.1)

lm8 = ols(total_incidentslog1p ~ percentlowgradeslog1p + percentacadnotimptlog1p + school_size + urban + crime_live_recode + crime_area_recode + school_type +  random_sweep + prohibit_phone + open_house + parent_teacher_conf + juvhelp_drug + mhhelp_drug + relighelp_drug + percentacadnotimptlog1p*juvhelp_drug + percentlowgradeslog1p*mhhelp_drug + percentacadnotimptlog1p*random_sweep + percentlowgradeslog1p*random_sweep + percentacadnotimptlog1p*prohibit_phone + percentlowgradeslog1p*prohibit_phone, data = sub, x = T, y = T)

lm8.1 = robcov(lm8)

print(lm8.1)
```

## Final Model

```{r}
lmfinal = ols(total_incidentslog1p ~ percentlowgradeslog1p + percentacadnotimptlog1p + school_size + urban + crime_live_recode + crime_area_recode + school_type +  random_sweep + prohibit_phone + open_house + parent_teacher_conf + juvhelp_drug + mhhelp_drug + relighelp_drug + percentacadnotimptlog1p*juvhelp_drug + percentlowgradeslog1p*mhhelp_drug + percentlowgradeslog1p*random_sweep, data = sub, x = T, y = T)

print(lmfinal)
```

Our main theoretical variable of interests, the socio-economic variables, remain statistically significant, net of all other variables considered. We can also discuss the other variables in this model, at length, for the value of other contributory explanatory factors for school safety. 

Now let us look at the preliminary results for what a Machine Learning approach can do for us.

